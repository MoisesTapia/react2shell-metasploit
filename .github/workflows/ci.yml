name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['2.7', '3.0', '3.1', '3.2']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler
        bundle install --jobs 4 --retry 3
        
    - name: Run RuboCop (Code Style)
      run: bundle exec rubocop --format github
      
    - name: Run RSpec (Unit Tests)
      run: |
        bundle exec rspec --format progress --format RspecJunitFormatter --out tmp/rspec_results.xml
        
    - name: Run Property-Based Tests
      run: |
        bundle exec rspec --tag property --format documentation
        
    - name: Run Integration Tests
      run: |
        bundle exec rspec --tag integration --format documentation
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-ruby-${{ matrix.ruby-version }}
        path: tmp/rspec_results.xml
        
    - name: Generate coverage report
      run: |
        bundle exec rspec --format html --out tmp/coverage.html
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-ruby-${{ matrix.ruby-version }}
        path: tmp/coverage.html

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler
        bundle install
        
    - name: Run RuboCop
      run: |
        bundle exec rubocop --format json --out tmp/rubocop_results.json
        bundle exec rubocop --format github
        
    - name: Run Reek (Code Smells)
      run: |
        gem install reek
        reek --format json lib/ > tmp/reek_results.json || true
        reek lib/
        
    - name: Run Flay (Code Duplication)
      run: |
        gem install flay
        flay lib/ > tmp/flay_results.txt || true
        cat tmp/flay_results.txt
        
    - name: Run Flog (Code Complexity)
      run: |
        gem install flog
        flog lib/ > tmp/flog_results.txt || true
        cat tmp/flog_results.txt
        
    - name: Upload lint results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results
        path: |
          tmp/rubocop_results.json
          tmp/reek_results.json
          tmp/flay_results.txt
          tmp/flog_results.txt

  security-basic:
    name: Basic Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Install security tools
      run: |
        gem install bundler-audit brakeman
        bundle install
        
    - name: Run Bundler Audit (Dependency Vulnerabilities)
      run: |
        bundle audit check --update
        
    - name: Run Brakeman (Security Scanner)
      run: |
        brakeman --format json --output tmp/brakeman_results.json --no-exit-on-warn --no-exit-on-error || true
        brakeman --format text
        
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        
    - name: Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-basic-results
        path: tmp/brakeman_results.json

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Install YARD
      run: gem install yard
      
    - name: Generate documentation
      run: |
        yard doc --output-dir tmp/docs
        
    - name: Check documentation coverage
      run: |
        yard stats --list-undoc > tmp/undocumented.txt
        cat tmp/undocumented.txt
        
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: |
          tmp/docs/
          tmp/undocumented.txt

  compatibility:
    name: Compatibility Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ruby-version: ['3.1']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler
        bundle install
        
    - name: Run verification script
      run: ruby verify_setup.rb
      
    - name: Run basic tests
      run: bundle exec rspec --tag ~integration --tag ~property

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler benchmark-ips memory_profiler
        bundle install
        
    - name: Run performance benchmarks
      run: |
        ruby -e "
        require 'benchmark/ips'
        require 'memory_profiler'
        require_relative 'lib/react2shell/payload_generator'
        
        generator = React2Shell::PayloadGenerator.new
        
        puts 'Performance Benchmarks:'
        Benchmark.ips do |x|
          x.report('payload_generation') do
            generator.create_file_exfiltration_payload('/etc/passwd', 'http://example.com')
          end
          
          x.report('javascript_escaping') do
            generator.escape_javascript('test \"string\" with \\'quotes\\'')
          end
        end
        
        puts 'Memory Usage:'
        report = MemoryProfiler.report do
          100.times do
            generator.create_file_exfiltration_payload('/etc/passwd', 'http://example.com')
          end
        end
        
        puts \"Total allocated: #{report.total_allocated_memsize} bytes\"
        puts \"Total retained: #{report.total_retained_memsize} bytes\"
        "

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, lint, security-basic, documentation, compatibility, performance]
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ needs.test.result == 'success' && needs.lint.result == 'success' && needs.security-basic.result == 'success' }}
      run: echo "✅ All CI checks passed successfully!"
      
    - name: Notify failure
      if: ${{ needs.test.result == 'failure' || needs.lint.result == 'failure' || needs.security-basic.result == 'failure' }}
      run: |
        echo "❌ CI checks failed:"
        echo "Test: ${{ needs.test.result }}"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Security: ${{ needs.security-basic.result }}"
        echo "Documentation: ${{ needs.documentation.result }}"
        echo "Compatibility: ${{ needs.compatibility.result }}"
        echo "Performance: ${{ needs.performance.result }}"