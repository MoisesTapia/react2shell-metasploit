# frozen_string_literal: true

require 'spec_helper'
require_relative '../../../lib/react2shell/exploit_engine'

RSpec.describe React2Shell::ExploitEngine do
  let(:mock_module) { create_mock_msf_module }
  let(:engine) { described_class.new(mock_module) }

  describe '#initialize' do
    it 'initializes all components' do
      expect(engine.config_manager).to be_a(React2Shell::ConfigurationManager)
      expect(engine.payload_generator).to be_a(React2Shell::PayloadGenerator)
      expect(engine.oob_listener).to be_a(React2Shell::OOBListener)
    end
  end

  describe '#check_vulnerability' do
    it 'returns Vulnerable when test payload succeeds' do
      response = create_mock_response(code: 200, body: 'REACT2SHELL_TEST')
      allow(mock_module).to receive(:send_request_cgi).and_return(response)
      
      result = engine.check_vulnerability
      expect(result).to be_a(Msf::Exploit::CheckCode)
    end

    it 'returns Safe when request is rejected' do
      response = create_mock_response(code: 404)
      allow(mock_module).to receive(:send_request_cgi).and_return(response)
      
      result = engine.check_vulnerability
      expect(result).to be_a(Msf::Exploit::CheckCode)
    end

    it 'returns Unknown when no response received' do
      allow(mock_module).to receive(:send_request_cgi).and_return(nil)
      
      result = engine.check_vulnerability
      expect(result).to be_a(Msf::Exploit::CheckCode)
    end
  end

  describe '#execute_exploit' do
    before do
      # Mock the OOB listener to avoid actual server startup
      allow(engine.oob_listener).to receive(:start_server)
      allow(engine.oob_listener).to receive(:stop_server)
      allow(engine.oob_listener).to receive(:has_received_data?).and_return(false)
    end

    it 'executes file exfiltration mode' do
      mock_module.datastore['FILEPATH'] = '/etc/passwd'
      mock_module.datastore['CMD'] = ''
      
      expect { engine.execute_exploit(:file_exfiltration) }.not_to raise_error
    end

    it 'executes command execution mode' do
      mock_module.datastore['CMD'] = 'ls -la'
      mock_module.datastore['FILEPATH'] = ''
      
      expect { engine.execute_exploit(:command_execution) }.not_to raise_error
    end

    it 'raises error for invalid mode' do
      expect { engine.execute_exploit(:invalid_mode) }.to raise_error(ArgumentError)
    end
  end

  describe '#handle_response' do
    it 'processes successful response' do
      response = create_mock_response(code: 200)
      result = engine.handle_response(response)
      
      expect(result[:success]).to be true
      expect(result[:code]).to eq(200)
      expect(result[:timestamp]).to be_a(Time)
    end

    it 'processes failed response' do
      response = create_mock_response(code: 500)
      result = engine.handle_response(response)
      
      expect(result[:success]).to be false
      expect(result[:code]).to eq(500)
    end

    it 'handles nil response' do
      result = engine.handle_response(nil)
      
      expect(result[:success]).to be false
      expect(result[:code]).to be_nil
      expect(result[:message]).to include('No response received')
    end
  end
end